# ClawBot Gateway + Web UI 反向代理
# 放到 nginx.conf 的 http{} 块内（和 codegame.conf 一样 include）
#
# 使用方法：
#   1. 将此文件放到 nginx 服务器 /usr/local/nginx/conf/clawbot.conf
#   2. 在 nginx.conf 的 http{} 块末尾添加: include clawbot.conf;
#   3. nginx -t && nginx -s reload
#
# 前提：
#   - 本地执行 bot ngrok 启动 ngrok 隧道
#   - ngrok 白名单里添加 nginx 服务器的出口 IP
#
# 域名：
#   - clawbot.yfqwl.com  → Gateway (WebSocket + HTTP)
#   - clawui.yfqwl.com   → Web UI

# ============================================
# ClawBot Gateway (支持 WebSocket)
# Android App 连接这个地址
# ============================================
server {
    listen       80;
    server_name  clawbot.yfqwl.com;
    server_tokens off;
    return 301 https://$host$request_uri;
}

server {
    listen       443 ssl;
    server_name  clawbot.yfqwl.com;
    server_tokens off;

    ssl_certificate     /usr/local/zhengshu/yfqwl.com/_.yfqwl.com.pem;
    ssl_certificate_key /usr/local/zhengshu/yfqwl.com/_.yfqwl.com.key;
    ssl_session_timeout 5m;
    ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE:ECDH:AES:HIGH:!NULL:!aNULL:!MD5:!ADH:!RC4;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_prefer_server_ciphers on;

    location / {
        # 代理到 ngrok 隧道地址
        proxy_pass https://clawbot.xnng.yfqwl.com;

        # WebSocket 支持（Gateway 使用 WebSocket 通信）
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;

        # 传递真实客户端信息
        proxy_set_header Host clawbot.xnng.yfqwl.com;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # 长连接超时（Gateway WebSocket 需要保持连接）
        proxy_read_timeout 3600s;
        proxy_send_timeout 3600s;
    }
}

# ============================================
# ClawBot Web UI
# 浏览器访问这个地址查看控制面板
# ============================================
server {
    listen       80;
    server_name  clawui.yfqwl.com;
    server_tokens off;
    return 301 https://$host$request_uri;
}

server {
    listen       443 ssl;
    server_name  clawui.yfqwl.com;
    server_tokens off;

    ssl_certificate     /usr/local/zhengshu/yfqwl.com/_.yfqwl.com.pem;
    ssl_certificate_key /usr/local/zhengshu/yfqwl.com/_.yfqwl.com.key;
    ssl_session_timeout 5m;
    ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE:ECDH:AES:HIGH:!NULL:!aNULL:!MD5:!ADH:!RC4;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_prefer_server_ciphers on;

    location / {
        # 代理到 ngrok UI 隧道
        proxy_pass https://clawui.xnng.yfqwl.com;

        # WebSocket 支持（Vite HMR 使用 WebSocket）
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;

        proxy_set_header Host clawui.xnng.yfqwl.com;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        proxy_read_timeout 3600s;
        proxy_send_timeout 3600s;
    }
}
